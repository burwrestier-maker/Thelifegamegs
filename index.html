<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BPS Chronicles - Definitive Edition</title>
    <link rel="icon" href="97071.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #f1c40f; --bg: #0d0e18; --panel: #1c1f33; --border: #4a517a;
            --common: #bdc3c7; --rare: #3498db; --epic: #9b59b6; --legendary: #f1c40f;
            --xp: #9b59b6;
        }

        /* CONFIGURA√á√ïES DE TOQUE E ZOOM */
        * { 
            box-sizing: border-box; 
            font-family: 'Press Start 2P', cursive; 
            touch-action: manipulation;
            user-select: none;
        }

        body { 
            margin: 0; 
            background: #000; 
            color: #e0e0e0; 
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        .ui-panel { 
            background: var(--panel); 
            border: 4px solid var(--border); 
            padding: 20px; 
            width: 95%; 
            max-width: 800px; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: perspective(1000px) rotateX(2deg);
            transition: transform 0.3s;
        }

        .screen { display: none; width: 100vw; height: 100vh; padding: 20px; flex-direction: column; align-items: center; justify-content: center; background-size: cover; background-position: center; }
        .active { display: flex; animation: sceneEnter 0.5s ease-out; }

        @keyframes sceneEnter {
            from { opacity: 0; transform: scale(1.1) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        .animate-shake { animation: shake 0.2s; }

        @keyframes slash {
            0% { transform: translateX(0) rotate(0); }
            50% { transform: translateX(50px) rotate(15deg) scale(1.2); }
            100% { transform: translateX(0); }
        }
        .animate-atk { animation: slash 0.3s ease-in-out; }

        @keyframes bossAtk {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); filter: brightness(1.5); }
            100% { transform: scale(1); }
        }
        .animate-boss-atk { animation: bossAtk 0.4s; }

        /* UI */
        .stats-banner { background: #000; border: 2px solid var(--gold); padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 9px; }
        
        input[type="text"], input[type="password"], select { 
            background: #000; border: 3px solid var(--border); color: var(--gold); 
            padding: 15px; font-size: 10px; width: 100%; text-align: center; 
            margin-bottom: 10px; outline: none;
        }

        button { 
            background: linear-gradient(to bottom, #222, #111); 
            color: var(--gold); 
            border: 2px solid var(--gold); 
            padding: 12px; 
            cursor: pointer; 
            font-size: 8px; 
            transition: 0.2s;
            box-shadow: 0 4px 0 #000;
        }
        button:hover:not(:disabled) { background: var(--gold); color: #000; }
        button:active { transform: translateY(3px); box-shadow: 0 1px 0 #000; }
        button:disabled { opacity: 0.3; filter: grayscale(1); }

        .card { background: #0d0e18; border: 2px solid #444; padding: 10px; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .card:hover { transform: translate(-2px, -2px); box-shadow: 4px 4px 0 var(--gold); }
        
        .item-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 250px; overflow-y: auto; padding: 5px; }
        .icon { width: 45px; height: 45px; background-size: 450px; image-rendering: pixelated; border: 1px solid #333; flex-shrink: 0; }

        .bar-container { width: 100%; height: 12px; background: #333; border: 2px solid #fff; margin: 4px 0; }
        .bar-fill { height: 100%; transition: width 0.4s; }
        .battle-log { background: #000; border: 2px solid var(--gold); height: 100px; width: 100%; overflow-y: auto; padding: 8px; font-size: 8px; color: #0f0; margin-top: 10px; line-height: 1.5; }
        .fs-btn { position: fixed; top: 10px; right: 10px; z-index: 1000; font-size: 6px; padding: 8px; border-radius: 5px; opacity: 0.7; }
        
        /* Raridades de Her√≥is */
        .rarity-H { border-color: #e67e22; box-shadow: 0 0 10px rgba(230, 126, 34, 0.5); }
    </style>
</head>
<body>
    <audio id="bgm" src="music.mp3" loop></audio>
    <button class="fs-btn" onclick="toggleFullscreen()">üì∫ TELA CHEIA</button>

    <div id="scr-start" class="screen active" style="background: radial-gradient(#1c1f33, #000);">
        <div class="ui-panel" style="max-width: 500px; text-align: center;">
            <h1 style="color:var(--gold); font-size: 18px; margin-bottom: 20px;">BPS CHRONICLES</h1>
            
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button onclick="setAuthMode('login')" id="tab-login" style="flex:1; background:var(--gold); color:#000;">LOGIN</button>
                <button onclick="setAuthMode('reg')" id="tab-reg" style="flex:1;">CADASTRO</button>
            </div>

            <input type="text" id="auth-user" placeholder="USU√ÅRIO / E-MAIL">
            <input type="password" id="auth-pass" placeholder="SENHA">

            <div id="char-setup" style="display:none; margin-top:10px;">
                <p style="font-size: 7px; margin-bottom: 5px;">NOME DO PERSONAGEM:</p>
                <input type="text" id="p-name-input" placeholder="NOME..." maxlength="12">
                <p style="font-size: 7px; margin-bottom: 5px;">RA√áA INICIAL:</p>
                <select id="p-race-select">
                    <option value="Mago">üßô MAGO</option>
                    <option value="Maldi√ß√£o">üíÄ MALDI√á√ÉO</option>
                    <option value="Humano">‚öîÔ∏è HUMANO</option>
                </select>
            </div>

            <button onclick="handleAuth()" style="width:100%; margin-top:15px; padding:15px;" id="auth-btn">ENTRAR NO JOGO</button>
        </div>
    </div>

    <div id="scr-hub" class="screen" style="background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('97057.jpg');">
        <div class="ui-panel">
            <div style="display: flex; justify-content: space-between; align-items: baseline; border-bottom: 2px solid var(--gold); padding-bottom: 5px; margin-bottom: 10px;">
                <h2 id="hub-name" style="color:var(--gold); margin: 0; font-size: 14px;">NOME</h2>
                <span id="hub-race" style="font-size: 8px; color: #aaa;">CLASSE</span>
            </div>
            <div class="stats-banner">
                <div>‚ù§Ô∏è HP: <span id="st-hp">100</span></div>
                <div>üíß MP: <span id="st-mana">50</span></div>
                <div>‚öîÔ∏è FOR: <span id="st-str">10</span></div>
                <div>‚ö° VEL: <span id="st-spd">10</span></div>
                <div style="grid-column: span 2; font-size:7px; color:#9b59b6;">LV: <span id="st-lv">1</span> | XP: <span id="st-xp-txt">0/100</span></div>
                <div class="bar-container" style="grid-column: span 2; height: 6px; border-color: var(--xp);"><div id="st-xp-bar" class="bar-fill" style="background: var(--xp); width: 0%;"></div></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="changeScreen('scr-battle')" style="grid-column: span 2; padding: 18px; font-size: 10px; background: #3d1414;">‚öîÔ∏è ENFRENTAR BOSS</button>
                <button onclick="changeScreen('scr-habits')">üèãÔ∏è MISS√ïES</button>
                <button onclick="changeScreen('scr-stats')">üë§ UPGRADE</button>
                <button onclick="changeScreen('scr-shop')">üõí LOJA</button>
                <button onclick="changeScreen('scr-inv')">üéí MOCHILA</button>
            </div>
            <p style="text-align:center; font-size:10px; margin-top:15px;">üí∞ SALDO: <span id="hub-coins">0</span> bps</p>
        </div>
    </div>

    <div id="scr-habits" class="screen" style="background:#000;"><div class="ui-panel"><button onclick="changeScreen('scr-hub')">< VOLTAR</button><h3 style="text-align:center;">MISS√ïES</h3><div style="display:flex; flex-direction:column; gap:8px; margin-top:15px;"><button onclick="addPoints(3, 'Corrida')">üèÉ CORRIDA (+3 PTS)</button><button onclick="addPoints(3, '√Ågua')">üíß √ÅGUA (+3 PTS)</button><button onclick="addPoints(6, 'Academia')">üèãÔ∏è ACADEMIA (+6 PTS)</button><button onclick="addPoints(5, 'Estudo')">üìö ESTUDO (+5 PTS)</button></div></div></div>
    
    <div id="scr-stats" class="screen" style="background:#000;"><div class="ui-panel"><button onclick="changeScreen('scr-hub')">< VOLTAR</button><h3 style="text-align:center;">TREINO</h3><p style="text-align:center; font-size: 9px;">PONTOS: <span id="train-pts">0</span></p><div style="display:flex; flex-direction:column; gap:12px;"><div style="display:flex; justify-content:space-between; align-items:center;">FOR√áA <button onclick="upgrade('str')">+</button></div><div style="display:flex; justify-content:space-between; align-items:center;">MANA <button onclick="upgrade('mana')">+</button></div><div style="display:flex; justify-content:space-between; align-items:center;">VEL <button onclick="upgrade('spd')">+</button></div><div style="display:flex; justify-content:space-between; align-items:center;">VIDA <button onclick="upgrade('hp')">+</button></div></div></div></div>

    <div id="scr-shop" class="screen" style="background:#000;"><div class="ui-panel"><button onclick="changeScreen('scr-hub')">< VOLTAR</button><h3 style="text-align:center; color:var(--gold);">LOJA</h3><div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;"><button onclick="renderShop('w')" style="flex:1;">ARMAS</button><button onclick="renderShop('a')" style="flex:1;">DEFESA</button><button onclick="renderShop('s')" style="flex:1;">SKILLS</button><button onclick="renderHeroesShop()" style="flex:1; background:#e67e22; color:#fff;">HER√ìIS</button></div><div id="shop-list" class="item-grid"></div></div></div>

    <div id="scr-inv" class="screen" style="background:#000;"><div class="ui-panel"><button onclick="changeScreen('scr-hub')">< VOLTAR</button><h3 style="text-align:center;">MEUS ITENS</h3><div id="inv-list" class="item-grid"></div></div></div>

    <div id="scr-battle" class="screen" style="background:#050505;">
        <div style="display:flex; justify-content:space-around; width:100%; align-items:flex-end; margin-bottom:20px;">
            <div id="fig-p" style="text-align:center; width: 140px;"><img id="bt-img-p" src="" style="width:100px; height: 100px; object-fit: cover; border:2px solid #fff;"><div class="bar-container"><div id="bt-hp-p" class="bar-fill" style="background:#2ecc71; width:100%;"></div></div><div class="bar-container"><div id="bt-mn-p" class="bar-fill" style="background:#3498db; width:100%;"></div></div><p style="font-size:7px;" id="bt-name-p">VOC√ä</p></div>
            <div id="fig-b" style="text-align:center; width: 160px;"><img id="bt-img-b" src="" style="width:130px; height: 130px; object-fit: cover; border:2px solid #f00;"><div class="bar-container"><div id="bt-hp-b" class="bar-fill" style="background:#e74c3c; width:100%;"></div></div><p id="bt-name-b" style="font-size:7px;">BOSS</p></div>
        </div>
        <div id="battle-log" class="battle-log"></div>
        <div id="battle-btns" style="display:flex; gap:10px; margin-top:20px; flex-wrap: wrap; justify-content: center;"></div>
    </div>

    <script>
        // --- 1. BANCO DE DADOS ---
        const RARITY = { 
            C: { n: 'Comum', m: 1, color: '#bdc3c7', cls: '' }, 
            R: { n: 'Raro', m: 4, color: '#3498db', cls: 'rarity-R' }, 
            E: { n: '√âpico', m: 15, color: '#9b59b6', cls: 'rarity-E' }, 
            L: { n: 'Lend√°rio', m: 50, color: '#f1c40f', cls: 'rarity-L' } 
        };

        const ITEMS = [
            { id: 'w1', t: 'w', n: 'Faca Mato', p: 50, atk: 15, r: RARITY.C, img: '97076.jpg', pos: '0 0' },
            { id: 'w2', t: 'w', n: 'Espada Real', p: 80, atk: 80, r: RARITY.R, img: '97076.jpg', pos: '-50px -100px' },
            { id: 'w3', t: 'w', n: 'Cajado Arcano', p: 300, atk: 250, r: RARITY.E, img: '97076.jpg', pos: '-100px -50px' },
            { id: 'w4', t: 'w', n: 'L√¢mina BPS', p: 150, atk: 500, r: RARITY.L, img: '97076.jpg', pos: '-250px -150px' },
            { id: 'a1', t: 'a', n: 'Pano Velho', p: 40, def: 10, r: RARITY.C, img: '97075.jpg', pos: '0 0' },
            { id: 'a2', t: 'a', n: 'Armadura Ferro', p: 200, def: 120, r: RARITY.R, img: '97075.jpg', pos: '-100px 0' },
            { id: 'a3', t: 'a', n: 'Capa √âgide', p: 120, def: 250, r: RARITY.L, img: '97075.jpg', pos: '-200px -150px' },
            { id: 's1', t: 's', n: 'Bola Fogo', p: 150, dmg: 150, r: RARITY.R, img: '97079.jpg', pos: '0 0', cost: 20 },
            { id: 's2', t: 's', n: 'Cura Divina', p: 150, heal: 120, r: RARITY.E, img: '97079.jpg', pos: '-50px 0', cost: 35 }
        ];

        const ALL_HEROES = [
            { id: 'h1', race: 'Mago', n: 'Arkan, o Mago da Produtividade', p: 1200, img: 'mago_arkan.jpg', bonus: { str: 5, mana: 60, spd: 5, hp: 0 } },
            { id: 'h2', race: 'Mago', n: 'Elyra, Tecel√£ do Foco', p: 1500, img: 'mago_elyra.jpg', bonus: { str: 0, mana: 100, spd: 10, hp: 0 } },
            { id: 'h3', race: 'Mago', n: 'Magnus, Guardi√£o do Tempo', p: 2000, img: 'mago_magnus.jpg', bonus: { str: 0, mana: 150, spd: 0, hp: 50 } },
            { id: 'h4', race: 'Mago', n: 'Selion, Mestre da Concentra√ß√£o', p: 1800, img: 'mago_selion.jpg', bonus: { str: 20, mana: 40, spd: 0, hp: 0 } },
            { id: 'h5', race: 'Humano', n: 'Alaric, o Cavalheiro da Disposi√ß√£o', p: 1200, img: 'hum_alaric.jpg', bonus: { str: 15, mana: 0, spd: -5, hp: 150 } },
            { id: 'h6', race: 'Humano', n: 'Brina, a Estrategista da Rotina', p: 1400, img: 'hum_brina.jpg', bonus: { str: 10, mana: 0, spd: 20, hp: 0 } },
            { id: 'h7', race: 'Humano', n: 'Dorian, o Executor Determinado', p: 1600, img: 'hum_dorian.jpg', bonus: { str: 25, mana: 0, spd: 10, hp: 0 } },
            { id: 'h8', race: 'Humano', n: 'Lina, a Guardi√£ do H√°bito', p: 1300, img: 'hum_lina.avif', bonus: { str: 12, mana: 0, spd: 8, hp: 80 } },
            { id: 'h9', race: 'Maldi√ß√£o', n: 'Prokrast, o Arquiteto do Descanso', p: 2200, img: 'mal_prokrast.jpg', bonus: { str: 0, mana: 200, spd: 0, hp: 0, def: 50 } },
            { id: 'h10', race: 'Maldi√ß√£o', n: 'N√©bula, a Claridade do Caos', p: 2500, img: 'mal_nebula.jpg', bonus: { str: 30, mana: 0, spd: 40, hp: 0 } },
            { id: 'h11', race: 'Maldi√ß√£o', n: 'Letargus, o Vigia da Energia', p: 2100, img: 'mal_letargus.webp', bonus: { str: 0, mana: 0, spd: 0, hp: 300, def: 100 } },
            { id: 'h12', race: 'Maldi√ß√£o', n: 'V√≥rtex, o Guardi√£o da Ordem Suprema', p: 3000, img: 'mal_vortex.jpg', bonus: { str: 100, mana: 0, spd: 0, hp: -50 } }
        ];

        const BOSSES = [
            { n: "Elemental", img: "97056.jpg", hp: 150, atk: 25, rew: 100 },
            { n: "Serpente", img: "97055.jpg", hp: 800, atk: 60, rew: 500 },
            { n: "Cervo Rei", img: "97054.jpg", hp: 2500, atk: 180, rew: 2000 },
            { n: "Olho Abissal", img: "97071.jpg", hp: 8000, atk: 500, rew: 10000 }
        ];

        let p = { bonusStr: 0, bonusHp: 0, bonusMana: 0, bonusSpd: 0, bonusDef: 0 }; 
        let currentAccount = null;
        let authMode = 'login';
        let bt = { active: false };

        // --- 2. SISTEMA DE AUTENTICA√á√ÉO ---
        function setAuthMode(m) {
            authMode = m;
            document.getElementById('char-setup').style.display = m === 'reg' ? 'block' : 'none';
            document.getElementById('auth-btn').textContent = m === 'reg' ? 'CRIAR CONTA' : 'ENTRAR NO JOGO';
        }

        function handleAuth() {
            const user = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            if(!user || !pass) return alert("Preencha tudo!");

            let accounts = JSON.parse(localStorage.getItem("bps_accounts")) || [];

            if(authMode === 'reg') {
                if(accounts.find(a => a.user === user)) return alert("Usu√°rio j√° existe!");
                const name = document.getElementById('p-name-input').value.trim();
                const race = document.getElementById('p-race-select').value;
                const imgMap = { 'Mago': '97072.jpg', 'Maldi√ß√£o': '97073.jpg', 'Humano': '97074.jpg' };
                
                p = { 
                    name, race, img: imgMap[race], coins: 100, pts: 0, lv: 1, xp: 0, xpNext: 100, 
                    str: 10, manaM: 50, spd: 10, hpM: 100, inv: [], bossIdx: 0, eqW: null, eqA: null,
                    bonusStr: 0, bonusHp: 0, bonusMana: 0, bonusSpd: 0, bonusDef: 0 
                };
                
                accounts.push({ user, pass, saveData: p });
                localStorage.setItem("bps_accounts", JSON.stringify(accounts));
                currentAccount = user;
                loginSuccess();
            } else {
                const acc = accounts.find(a => a.user === user && a.pass === pass);
                if(acc) { p = acc.saveData; currentAccount = user; loginSuccess(); }
                else alert("Erro!");
            }
        }

        function loginSuccess() { document.getElementById("bgm").play().catch(()=>{}); changeScreen('scr-hub'); }
        function saveGame() {
            if(!currentAccount) return;
            let accounts = JSON.parse(localStorage.getItem("bps_accounts")) || [];
            const idx = accounts.findIndex(a => a.user === currentAccount);
            if(idx !== -1) { accounts[idx].saveData = p; localStorage.setItem("bps_accounts", JSON.stringify(accounts)); }
        }

        // --- 3. L√ìGICA CORE ---
        function changeScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'scr-shop') renderShop('w');
            if(id === 'scr-inv') renderInv();
            if(id === 'scr-battle') startBattle();
            updateUI();
        }

        function updateUI() {
            if(!p.name) return;
            document.getElementById("hub-name").textContent = p.name.toUpperCase();
            document.getElementById("hub-race").textContent = p.race.toUpperCase();
            document.getElementById("st-lv").textContent = p.lv;
            document.getElementById("st-hp").textContent = p.hpM + (p.bonusHp || 0);
            document.getElementById("st-mana").textContent = p.manaM + (p.bonusMana || 0);
            document.getElementById("st-str").textContent = p.str + (p.bonusStr || 0);
            document.getElementById("st-spd").textContent = p.spd + (p.bonusSpd || 0);
            document.getElementById("st-pts").textContent = p.pts;
            document.getElementById("train-pts").textContent = p.pts;
            document.getElementById("hub-coins").textContent = p.coins;
            document.getElementById("st-xp-txt").textContent = `${p.xp}/${p.xpNext}`;
            document.getElementById("st-xp-bar").style.width = (p.xp / p.xpNext * 100) + "%";
            saveGame();
        }

        function addPoints(v) { p.pts += v; p.xp += v*10; if(p.xp>=p.xpNext){ p.lv++; p.xp=0; p.xpNext*=1.5; p.pts+=5; alert("LEVEL UP!"); } updateUI(); }
        function upgrade(stat) {
            if(p.pts <= 0) return;
            if(stat==='str') p.str+=2; if(stat==='mana') p.manaM+=15; if(stat==='spd') p.spd+=2; if(stat==='hp') p.hpM+=10;
            p.pts--; updateUI();
        }

        // --- 4. LOJA E INVENT√ÅRIO ---
        function renderShop(type) {
            const list = document.getElementById("shop-list"); list.innerHTML = "";
            ITEMS.filter(i => i.t === type).forEach(item => {
                const cost = item.p * item.r.m;
                const owned = p.inv.some(o => o.id === item.id);
                list.innerHTML += `<div class="card ${item.r.cls}"><div class="icon" style="background-image:url('${item.img}'); background-position:${item.pos}"></div><div style="flex-grow:1; font-size:6px;"><b>${item.n}</b></div><button onclick="buyItem('${item.id}')" ${owned || p.coins < cost ? 'disabled' : ''}>${owned ? 'OK' : cost}</button></div>`;
            });
        }

        function renderHeroesShop() {
            const list = document.getElementById("shop-list"); list.innerHTML = "";
            ALL_HEROES.forEach(h => {
                const owned = p.inv.some(o => o.id === h.id);
                list.innerHTML += `<div class="card rarity-H"><img src="${h.img}" style="width:45px; height:45px; object-fit:cover; border-radius:5px;"><div style="flex-grow:1; font-size:6px;"><b>${h.n}</b></div><button onclick="buyHero('${h.id}')" ${owned || p.coins < h.p ? 'disabled' : ''}>${owned ? 'OK' : h.p}</button></div>`;
            });
        }

        function buyItem(id) {
            const it = ITEMS.find(i => i.id === id); const cost = it.p * it.r.m;
            if(p.coins >= cost) { p.coins -= cost; p.inv.push(JSON.parse(JSON.stringify(it))); updateUI(); renderShop(it.t); }
        }

        function buyHero(id) {
            const h = ALL_HEROES.find(i => i.id === id);
            if(p.coins >= h.p) { p.coins -= h.p; p.inv.push({...h, t: 'h'}); updateUI(); renderHeroesShop(); }
        }

        function renderInv() {
            const list = document.getElementById("inv-list"); list.innerHTML = "";
            p.inv.forEach((it, idx) => {
                const isEq = (p.eqW?.id === it.id || p.eqA?.id === it.id || p.img === it.img);
                list.innerHTML += `<div class="card" style="border-color:${isEq?'var(--gold)':'#444'}"><img src="${it.img}" class="icon" style="object-fit:cover; background-position:${it.pos || 'center'}"><div style="flex-grow:1; font-size:6px;"><b>${it.n}</b></div><button onclick="toggleEquip(${idx})">${isEq?'DESEQ':'EQUIP'}</button></div>`;
            });
        }

        function toggleEquip(idx) {
            const it = p.inv[idx];
            if(it.t === 'h') {
                p.img = it.img; p.race = it.race;
                p.bonusStr = it.bonus.str || 0; p.bonusHp = it.bonus.hp || 0;
                p.bonusMana = it.bonus.mana || 0; p.bonusSpd = it.bonus.spd || 0;
                p.bonusDef = it.bonus.def || 0;
            } else {
                if(it.t === 'w') p.eqW = (p.eqW?.id === it.id) ? null : it;
                if(it.t === 'a') p.eqA = (p.eqA?.id === it.id) ? null : it;
            }
            updateUI(); renderInv();
        }

        // --- 5. BATALHA ---
        function startBattle() {
            const boss = BOSSES[p.bossIdx]; if(!boss) return changeScreen('scr-hub');
            bt = { 
                active: true, 
                pHP: p.hpM + (p.bonusHp||0), pMaxHP: p.hpM + (p.bonusHp||0),
                pMN: p.manaM + (p.bonusMana||0), pMaxMN: p.manaM + (p.bonusMana||0),
                bHP: boss.hp, bMaxHP: boss.hp,
                atkP: p.str + (p.bonusStr||0) + (p.eqW?p.eqW.atk:0),
                defP: (p.bonusDef||0) + (p.eqA?p.eqA.def:0)
            };
            document.getElementById("bt-img-p").src = p.img; document.getElementById("bt-img-b").src = boss.img;
            document.getElementById("battle-btns").innerHTML = `<button onclick="atkP()">‚öîÔ∏è ATACAR</button>`;
            p.inv.filter(i=>i.t==='s').forEach(s => {
                document.getElementById("battle-btns").innerHTML += `<button onclick="useS('${s.id}')">‚ú® ${s.n}</button>`;
            });
            refreshBars();
        }

        function atkP() {
            if(!bt.active) return;
            let dmg = Math.floor(bt.atkP * (0.8 + Math.random()*0.4));
            bt.bHP -= dmg; log(`Dano no Boss: ${dmg}`, '#0f0');
            if(bt.bHP <= 0) return win();
            setTimeout(bossT, 600);
        }

        function useS(id) {
            const s = ITEMS.find(i=>i.id===id); if(bt.pMN < s.cost) return;
            bt.pMN -= s.cost;
            if(s.dmg) { bt.bHP -= s.dmg; log(`Habilidade: ${s.dmg}`, 'cyan'); }
            else { bt.pHP = Math.min(bt.pMaxHP, bt.pHP + s.heal); log(`Cura: ${s.heal}`, 'cyan'); }
            refreshBars(); if(bt.bHP <= 0) return win();
            setTimeout(bossT, 600);
        }

        function bossT() {
            const b = BOSSES[p.bossIdx];
            let dmg = Math.max(5, b.atk - (bt.defP/5));
            bt.pHP -= Math.floor(dmg); log(`Dano recebido: ${dmg.toFixed(0)}`, 'red');
            refreshBars(); if(bt.pHP <= 0) { alert("Derrota!"); changeScreen('scr-hub'); }
        }

        function win() {
            const b = BOSSES[p.bossIdx]; p.coins += b.rew; p.bossIdx++;
            alert("Vitoria!"); changeScreen('scr-hub');
        }

        function log(m, c) { const l = document.getElementById("battle-log"); l.innerHTML = `<div style="color:${c}">> ${m}</div>` + l.innerHTML; }
        function refreshBars() {
            document.getElementById("bt-hp-p").style.width = (bt.pHP/bt.pMaxHP*100)+"%";
            document.getElementById("bt-hp-b").style.width = (bt.bHP/bt.bMaxHP*100)+"%";
            document.getElementById("bt-mn-p").style.width = (bt.pMN/bt.pMaxMN*100)+"%";
        }
        function toggleFullscreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
    </script>
</body>
</html>